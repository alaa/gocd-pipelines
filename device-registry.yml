---
group: device-registry12
pipelines:
  - name: build
    env: build
    materials:
      - type: git
        repo: https://github.com/advancedtelematic/rvi_sota_server.git
        branch: demo
    stages:
      - name: sbt-release
        manual: false
        jobs:
          - name: sbt-release
            tasks:
              - type: exec
                command: sbt sota-device_registry/docker:publish && tag=$(git describe); echo ${tag:1}-SNAPSHOT > artifact.txt
  - name: ci.deploy
    env: build
    materials:
      - type: git
        repo: git@github.com:advancedtelematic/sota-deploy.git
        branch: master
      - type: dependency
        upstream_pipeline: device-registry12.build
        upstream_stage: sbt-release
    stages:
      - name: marathon
        manual: false
        jobs:
          - name: deploy
            tasks:
              - type: fetch_artifact
                upstream_pipeline: device-registry12.build
                upstream_stage: sbt-release
                upstream_job: sbt-release
              - type: exec
                command: ./deploy-env/deploy.sh ci device-registry advancedtelematic/sota-device_registry:$(cat artifact.txt)
